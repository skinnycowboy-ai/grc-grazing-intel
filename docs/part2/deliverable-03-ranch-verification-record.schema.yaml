# Ranch Verification Record â€” schema (YAML)

# Notes:
# - This is a "record schema + example record" in one file for reviewer readability.
# - In production, split into JSON Schema + OpenAPI models.

schema_version: 1

types:
  RanchVerificationRecord:
    description: >
      Canonical, audit-ready verification record for a ranch and reporting period.
      References immutable evidence snapshots and captures tier recommendation + human approval trail.
    required:
      - record_id
      - ranch_id
      - period
      - protocol
      - status
      - recommended_tier
      - policy
      - snapshots
      - claims
      - evidence_pack
      - audit_trail
    properties:
      record_id: { type: string, description: "Stable UUID for the record (not a run id)." }
      ranch_id: { type: string }
      period:
        type: object
        required: [period_id, start_date, end_date]
        properties:
          period_id: { type: string, description: "e.g. 2026-Q1" }
          start_date: { type: string, format: date }
          end_date: { type: string, format: date }
      protocol:
        type: object
        required: [protocol_name, protocol_version]
        properties:
          protocol_name: { type: string, description: "e.g. CAR-SEP / TRS" }
          protocol_version: { type: string }
      status:
        type: string
        enum: [DRAFT, NOT_READY, NEEDS_REVIEW, RECOMMENDED, APPROVED_LOCKED, REJECTED]
      recommended_tier:
        type: string
        enum: [NONE, GOOD, BETTER, BEST]
      effective_tier_window:
        type: object
        description: "Optional: support mid-period tier transitions."
        properties:
          tier_effective_date: { type: string, format: date }
          tier_end_date: { type: string, format: date }
      confidence:
        type: object
        properties:
          score: { type: number, minimum: 0, maximum: 1 }
          drivers: { type: array, items: { type: string } }
      policy:
        type: object
        required: [policy_version, policy_hash, evaluated_at, engine_version]
        properties:
          policy_version: { type: string }
          policy_hash: { type: string, description: "sha256 of the policy file bundle" }
          evaluated_at: { type: string, format: date-time }
          engine_version: { type: string, description: "verification engine build/version" }
      snapshots:
        type: array
        description: "Immutable snapshot pointers for each source used in evaluation."
        items:
          type: object
          required: [source, snapshot_id, snapshot_hash, captured_at, uri]
          properties:
            source: { type: string, enum: [pasturemap, salesforce, soil_lab, hardware, docs] }
            snapshot_id: { type: string }
            snapshot_hash: { type: string }
            captured_at: { type: string, format: date-time }
            uri: { type: string, description: "Object storage URI (access controlled)" }
            connector_version: { type: string }
            schema_version: { type: string }
      completeness_gates:
        type: array
        items:
          type: object
          required: [gate_name, passed, severity, details]
          properties:
            gate_name: { type: string }
            passed: { type: boolean }
            severity: { type: string, enum: [INFO, WARN, CRIT] }
            details: { type: object, additionalProperties: true }
      claims:
        type: array
        description: "Machine-checkable assertions derived from evidence."
        items:
          type: object
          required: [claim_id, name, satisfied, evidence_refs]
          properties:
            claim_id: { type: string }
            name: { type: string }
            satisfied: { type: boolean }
            measured_at: { type: string, format: date-time }
            metrics: { type: object, additionalProperties: true }
            evidence_refs:
              type: array
              items:
                type: object
                required: [evidence_id, kind]
                properties:
                  evidence_id: { type: string }
                  kind: { type: string, enum: [document, event, lab_result, checkin, sensor_event, map] }
      conflicts:
        type: array
        description: "Ambiguities/conflicts requiring human adjudication."
        items:
          type: object
          required: [code, severity, summary]
          properties:
            code: { type: string }
            severity: { type: string, enum: [WARN, CRIT] }
            summary: { type: string }
            details: { type: object, additionalProperties: true }
      evidence_pack:
        type: object
        required: [pack_id, manifest_hash, uri, created_at]
        properties:
          pack_id: { type: string }
          manifest_hash: { type: string }
          uri: { type: string }
          created_at: { type: string, format: date-time }
      human_review:
        type: object
        description: "Latest review decision (audit trail retains full history)."
        properties:
          assigned_to: { type: string }
          decision: { type: string, enum: [APPROVE, REJECT, REQUEST_INFO, OVERRIDE] }
          decided_at: { type: string, format: date-time }
          override_tier: { type: string, enum: [GOOD, BETTER, BEST] }
          reason_code: { type: string }
          notes: { type: string }
          attachments:
            type: array
            items:
              type: object
              required: [uri, sha256]
              properties:
                uri: { type: string }
                sha256: { type: string }
      audit_trail:
        type: array
        description: "Append-only list of actions for regulatory audit."
        items:
          type: object
          required: [actor, action, at, details]
          properties:
            actor: { type: string }
            action: { type: string }
            at: { type: string, format: date-time }
            details: { type: object, additionalProperties: true }

example_record:
  record_id: "rvrec_8d2b4b4f-7c0f-4a66-9c66-8bd31f9b5b0a"
  ranch_id: "ranch_mock_mimms_unit"
  period:
    period_id: "2026-Q1"
    start_date: "2026-01-01"
    end_date: "2026-03-31"
  protocol:
    protocol_name: "CAR-SEP"
    protocol_version: "vX.Y"
  status: "NEEDS_REVIEW"
  recommended_tier: "BETTER"
  confidence:
    score: 0.78
    drivers:
      - "GMP present; soil sampling complete; soil map present"
      - "PastureMap move density meets threshold"
      - "Boundary overlap discrepancy between LSA and PastureMap requires adjudication"
  policy:
    policy_version: "2026-02-01"
    policy_hash: "sha256:aaaaaaaa..."
    evaluated_at: "2026-02-19T22:12:33Z"
    engine_version: "verifier-1.3.0"
  snapshots:
    - source: "docs"
      snapshot_id: "snap_docs_01"
      snapshot_hash: "sha256:bbbbbbbb..."
      captured_at: "2026-02-19T21:50:00Z"
      uri: "s3://evidence/raw/docs/ranch_mock_mimms_unit/2026-Q1/snap_docs_01/"
      connector_version: "docs-ingest-0.2.0"
      schema_version: "1"
    - source: "pasturemap"
      snapshot_id: "snap_pm_02"
      snapshot_hash: "sha256:cccccccc..."
      captured_at: "2026-02-19T21:55:00Z"
      uri: "s3://evidence/raw/pasturemap/ranch_mock_mimms_unit/2026-Q1/snap_pm_02/"
      connector_version: "pm-connector-0.9.1"
      schema_version: "3"
  completeness_gates:
    - gate_name: "lsa_present_and_parsed"
      passed: true
      severity: "INFO"
      details: { pages: 12 }
    - gate_name: "soil_sampling_results_present"
      passed: true
      severity: "INFO"
      details: { samples: 18 }
    - gate_name: "pasturemap_moves_present"
      passed: true
      severity: "INFO"
      details: { moves: 76, min_required: 12 }
  claims:
    - claim_id: "claim_gmp_on_file"
      name: "gmp_on_file"
      satisfied: true
      measured_at: "2026-02-19T22:12:33Z"
      evidence_refs:
        - evidence_id: "evid_doc_gmp_pdf"
          kind: "document"
    - claim_id: "claim_quarterly_checkins"
      name: "quarterly_checkins_complete"
      satisfied: false
      measured_at: "2026-02-19T22:12:33Z"
      evidence_refs:
        - evidence_id: "evid_sf_checkins"
          kind: "checkin"
  conflicts:
    - code: "LSA_PM_BOUNDARY_MISMATCH"
      severity: "CRIT"
      summary: "PastureMap paddocks extend beyond LSA enrolled parcels by >3% area."
      details: { overlap_pct: 0.965, threshold: 0.99 }
  evidence_pack:
    pack_id: "pack_2026Q1_ranch_mock_mimms_unit_run_77"
    manifest_hash: "sha256:dddddddd..."
    uri: "s3://evidence/packs/ranch_mock_mimms_unit/2026-Q1/pack_77/"
    created_at: "2026-02-19T22:12:35Z"
  audit_trail:
    - actor: "system"
      action: "EVALUATED_POLICY"
      at: "2026-02-19T22:12:35Z"
      details: { policy_version: "2026-02-01" }
    - actor: "mrv_reviewer_12"
      action: "FLAGGED_CONFLICT"
      at: "2026-02-20T15:04:09Z"
      details: { code: "LSA_PM_BOUNDARY_MISMATCH" }
